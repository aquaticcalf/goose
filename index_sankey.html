<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Sankey Diagram</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            resize: vertical;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .sample-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .sample-buttons button {
            background-color: #2196F3;
        }
        
        .sample-buttons button:hover {
            background-color: #1976D2;
        }
        
        #sankey {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            display: block;
            margin: 0 auto;
        }
        
        .node rect {
            cursor: pointer;
            stroke: #000;
            stroke-width: 1px;
        }
        
        .node text {
            pointer-events: none;
            font-size: 12px;
            font-weight: bold;
        }
        
        .link {
            fill: none;
            stroke-opacity: 0.5;
            cursor: pointer;
        }
        
        .link:hover {
            stroke-opacity: 0.8;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .info {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .info h3 {
            margin-top: 0;
            color: #0d47a1;
        }
        
        .info code {
            background-color: #bbdefb;
            padding: 2px 4px;
            border-radius: 2px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Interactive Sankey Diagram</h1>
        
        <div class="info">
            <h3>About Sankey Diagrams</h3>
            <p>Sankey diagrams visualize flow data between different nodes. The width of each flow is proportional to the quantity being transferred. Perfect for showing:</p>
            <ul>
                <li><strong>Energy flows</strong> - Power generation to consumption</li>
                <li><strong>Budget allocation</strong> - Income sources to expenses</li>
                <li><strong>Website traffic</strong> - User journeys and conversions</li>
                <li><strong>Supply chains</strong> - Materials through production stages</li>
            </ul>
        </div>
        
        <div class="controls">
            <div style="width: 100%;">
                <label for="jsonInput"><strong>Sankey Data (JSON):</strong></label>
                <div class="sample-buttons">
                    <button onclick="loadSampleData('energy')">Energy Flow</button>
                    <button onclick="loadSampleData('budget')">Budget Flow</button>
                    <button onclick="loadSampleData('website')">Website Traffic</button>
                    <button onclick="loadSampleData('supply')">Supply Chain</button>
                </div>
                <textarea id="jsonInput" placeholder="Enter your Sankey data in JSON format..."></textarea>
                <div style="margin-top: 10px;">
                    <button onclick="renderSankey()">Render Sankey</button>
                    <button onclick="clearSankey()">Clear</button>
                </div>
                <div id="error-message"></div>
            </div>
        </div>
        
        <svg id="sankey" width="1000" height="600"></svg>
        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // Sample data sets
        const sampleData = {
            energy: {
                nodes: [
                    { name: "Coal", category: "source" },
                    { name: "Natural Gas", category: "source" },
                    { name: "Nuclear", category: "source" },
                    { name: "Solar", category: "source" },
                    { name: "Wind", category: "source" },
                    { name: "Power Plant", category: "generation" },
                    { name: "Grid", category: "distribution" },
                    { name: "Residential", category: "consumption" },
                    { name: "Industrial", category: "consumption" },
                    { name: "Commercial", category: "consumption" },
                    { name: "Losses", category: "loss" }
                ],
                links: [
                    { source: "Coal", target: "Power Plant", value: 35 },
                    { source: "Natural Gas", target: "Power Plant", value: 40 },
                    { source: "Nuclear", target: "Power Plant", value: 20 },
                    { source: "Solar", target: "Grid", value: 8 },
                    { source: "Wind", target: "Grid", value: 12 },
                    { source: "Power Plant", target: "Grid", value: 95 },
                    { source: "Grid", target: "Residential", value: 38 },
                    { source: "Grid", target: "Industrial", value: 45 },
                    { source: "Grid", target: "Commercial", value: 25 },
                    { source: "Grid", target: "Losses", value: 7 }
                ]
            },
            budget: {
                nodes: [
                    { name: "Salary", category: "income" },
                    { name: "Investments", category: "income" },
                    { name: "Side Business", category: "income" },
                    { name: "Total Income", category: "pool" },
                    { name: "Housing", category: "expense" },
                    { name: "Food", category: "expense" },
                    { name: "Transportation", category: "expense" },
                    { name: "Entertainment", category: "expense" },
                    { name: "Savings", category: "savings" },
                    { name: "Emergency Fund", category: "savings" }
                ],
                links: [
                    { source: "Salary", target: "Total Income", value: 5000 },
                    { source: "Investments", target: "Total Income", value: 800 },
                    { source: "Side Business", target: "Total Income", value: 1200 },
                    { source: "Total Income", target: "Housing", value: 2000 },
                    { source: "Total Income", target: "Food", value: 800 },
                    { source: "Total Income", target: "Transportation", value: 600 },
                    { source: "Total Income", target: "Entertainment", value: 500 },
                    { source: "Total Income", target: "Savings", value: 2000 },
                    { source: "Total Income", target: "Emergency Fund", value: 1100 }
                ]
            },
            website: {
                nodes: [
                    { name: "Google Search", category: "source" },
                    { name: "Social Media", category: "source" },
                    { name: "Direct", category: "source" },
                    { name: "Email", category: "source" },
                    { name: "Homepage", category: "landing" },
                    { name: "Product Page", category: "page" },
                    { name: "About Page", category: "page" },
                    { name: "Contact", category: "page" },
                    { name: "Purchase", category: "conversion" },
                    { name: "Newsletter", category: "conversion" },
                    { name: "Exit", category: "exit" }
                ],
                links: [
                    { source: "Google Search", target: "Homepage", value: 1000 },
                    { source: "Social Media", target: "Homepage", value: 300 },
                    { source: "Direct", target: "Homepage", value: 200 },
                    { source: "Email", target: "Product Page", value: 150 },
                    { source: "Homepage", target: "Product Page", value: 800 },
                    { source: "Homepage", target: "About Page", value: 400 },
                    { source: "Homepage", target: "Exit", value: 300 },
                    { source: "Product Page", target: "Purchase", value: 120 },
                    { source: "Product Page", target: "Contact", value: 200 },
                    { source: "Product Page", target: "Exit", value: 630 },
                    { source: "About Page", target: "Contact", value: 100 },
                    { source: "About Page", target: "Newsletter", value: 80 },
                    { source: "About Page", target: "Exit", value: 220 },
                    { source: "Contact", target: "Purchase", value: 50 },
                    { source: "Contact", target: "Exit", value: 250 }
                ]
            },
            supply: {
                nodes: [
                    { name: "Raw Materials", category: "input" },
                    { name: "Suppliers", category: "input" },
                    { name: "Manufacturing", category: "process" },
                    { name: "Quality Control", category: "process" },
                    { name: "Warehouse", category: "storage" },
                    { name: "Distribution", category: "logistics" },
                    { name: "Retail Stores", category: "retail" },
                    { name: "Online Sales", category: "retail" },
                    { name: "Customers", category: "end" },
                    { name: "Returns", category: "reverse" },
                    { name: "Waste", category: "waste" }
                ],
                links: [
                    { source: "Raw Materials", target: "Manufacturing", value: 1000 },
                    { source: "Suppliers", target: "Manufacturing", value: 500 },
                    { source: "Manufacturing", target: "Quality Control", value: 1500 },
                    { source: "Quality Control", target: "Warehouse", value: 1400 },
                    { source: "Quality Control", target: "Waste", value: 100 },
                    { source: "Warehouse", target: "Distribution", value: 1400 },
                    { source: "Distribution", target: "Retail Stores", value: 800 },
                    { source: "Distribution", target: "Online Sales", value: 600 },
                    { source: "Retail Stores", target: "Customers", value: 750 },
                    { source: "Online Sales", target: "Customers", value: 580 },
                    { source: "Retail Stores", target: "Returns", value: 50 },
                    { source: "Online Sales", target: "Returns", value: 20 },
                    { source: "Returns", target: "Warehouse", value: 70 }
                ]
            }
        };

        // Sankey variables
        let svg, sankey, tooltip;
        const width = 1000;
        const height = 600;
        const margin = { top: 20, right: 20, bottom: 20, left: 20 };

        // Color schemes for different categories
        const colorSchemes = {
            source: "#ff6b6b",
            income: "#4ecdc4",
            input: "#45b7d1",
            generation: "#f9ca24",
            process: "#f0932b",
            pool: "#6c5ce7",
            distribution: "#a29bfe",
            logistics: "#fd79a8",
            landing: "#00b894",
            page: "#00cec9",
            storage: "#fdcb6e",
            retail: "#e17055",
            consumption: "#74b9ff",
            expense: "#fd79a8",
            conversion: "#00b894",
            end: "#00b894",
            savings: "#55a3ff",
            loss: "#636e72",
            exit: "#636e72",
            reverse: "#ddd",
            waste: "#636e72"
        };

        // Initialize
        function initializeSVG() {
            svg = d3.select("#sankey")
                .attr("width", width)
                .attr("height", height);
            
            svg.selectAll("*").remove();
            
            sankey = d3.sankey()
                .nodeWidth(20)
                .nodePadding(10)
                .extent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]]);
            
            tooltip = d3.select("#tooltip");
        }

        // Load sample data
        function loadSampleData(type) {
            const data = sampleData[type];
            document.getElementById('jsonInput').value = JSON.stringify(data, null, 2);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 5000);
        }

        // Render the Sankey diagram
        function renderSankey() {
            const jsonInput = document.getElementById('jsonInput').value.trim();
            
            if (!jsonInput) {
                showError('Please enter JSON data or load a sample.');
                return;
            }

            let data;
            try {
                data = JSON.parse(jsonInput);
            } catch (e) {
                showError('Invalid JSON format. Please check your data.');
                return;
            }

            if (!data.nodes || !data.links) {
                showError('JSON must contain "nodes" and "links" arrays.');
                return;
            }

            // Validate links reference valid nodes
            const nodeNames = new Set(data.nodes.map(d => d.name));
            const invalidLinks = data.links.filter(link => 
                !nodeNames.has(link.source) || !nodeNames.has(link.target)
            );
            
            if (invalidLinks.length > 0) {
                showError('Some links reference non-existent nodes. Check your source/target values.');
                return;
            }

            initializeSVG();
            drawSankey(data);
        }

        // Draw the Sankey diagram
        function drawSankey(data) {
            // Create a map of node names to indices
            const nodeMap = new Map();
            data.nodes.forEach((node, index) => {
                nodeMap.set(node.name, index);
            });

            // Process data for D3 Sankey - convert node names to indices in links
            const processedLinks = data.links.map(link => ({
                source: nodeMap.get(link.source),
                target: nodeMap.get(link.target),
                value: link.value
            }));

            const graph = sankey({
                nodes: data.nodes.map(d => ({ ...d })),
                links: processedLinks
            });

            // Draw links
            svg.append("g")
                .selectAll("path")
                .data(graph.links)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", d => {
                    const sourceCategory = d.source.category;
                    return colorSchemes[sourceCategory] || "#999";
                })
                .attr("stroke-width", d => Math.max(1, d.width))
                .on("mouseover", function(event, d) {
                    showLinkTooltip(event, d);
                })
                .on("mouseout", hideTooltip);

            // Draw nodes
            const node = svg.append("g")
                .selectAll("g")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "node");

            node.append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0)
                .attr("width", d => d.x1 - d.x0)
                .attr("fill", d => colorSchemes[d.category] || "#69b3a2")
                .on("mouseover", function(event, d) {
                    showNodeTooltip(event, d);
                })
                .on("mouseout", hideTooltip);

            // Add node labels
            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .text(d => d.name)
                .style("font-size", "12px")
                .style("fill", "#333");
        }

        // Tooltip functions
        function showNodeTooltip(event, d) {
            const totalIn = d.targetLinks.reduce((sum, link) => sum + link.value, 0);
            const totalOut = d.sourceLinks.reduce((sum, link) => sum + link.value, 0);
            
            tooltip.style("opacity", 1)
                .html(`
                    <strong>${d.name}</strong><br/>
                    Category: ${d.category || 'N/A'}<br/>
                    Total In: ${totalIn.toLocaleString()}<br/>
                    Total Out: ${totalOut.toLocaleString()}<br/>
                    Net: ${(totalIn - totalOut).toLocaleString()}
                `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }

        function showLinkTooltip(event, d) {
            tooltip.style("opacity", 1)
                .html(`
                    <strong>Flow</strong><br/>
                    From: ${d.source.name}<br/>
                    To: ${d.target.name}<br/>
                    Value: ${d.value.toLocaleString()}<br/>
                    Width: ${d.width.toFixed(1)}px
                `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }

        function hideTooltip() {
            tooltip.style("opacity", 0);
        }

        // Clear Sankey
        function clearSankey() {
            if (svg) {
                svg.selectAll("*").remove();
            }
        }

        // Load energy sample on page load
        window.onload = function() {
            loadSampleData('energy');
        };
    </script>
</body>
</html>
