<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Chord Diagram</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            resize: vertical;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .sample-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .sample-buttons button {
            background-color: #2196F3;
        }
        
        .sample-buttons button:hover {
            background-color: #1976D2;
        }
        
        #chord {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            display: block;
            margin: 0 auto;
        }
        
        .group-arc {
            cursor: pointer;
        }
        
        .chord {
            cursor: pointer;
            fill-opacity: 0.67;
            stroke: #000;
            stroke-width: 0.5px;
        }
        
        .chord:hover {
            fill-opacity: 0.9;
        }
        
        .group-label {
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            pointer-events: none;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .info {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .info h3 {
            margin-top: 0;
            color: #0d47a1;
        }
        
        .info code {
            background-color: #bbdefb;
            padding: 2px 4px;
            border-radius: 2px;
            font-family: monospace;
        }
        
        .fade {
            opacity: 0.1;
        }
        
        .highlight {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Interactive Chord Diagram</h1>
        
        <div class="info">
            <h3>About Chord Diagrams</h3>
            <p>Chord diagrams show relationships and flows between entities arranged in a circle. The thickness of each chord represents the strength of the relationship. Perfect for visualizing:</p>
            <ul>
                <li><strong>Migration flows</strong> - Population movement between countries/regions</li>
                <li><strong>Trade relationships</strong> - Import/export between nations</li>
                <li><strong>Communication patterns</strong> - Email, calls, or messages between groups</li>
                <li><strong>Collaboration networks</strong> - Co-authorship, partnerships, or teamwork</li>
            </ul>
        </div>
        
        <div class="controls">
            <div style="width: 100%;">
                <label for="jsonInput"><strong>Chord Data (JSON):</strong></label>
                <div class="sample-buttons">
                    <button onclick="loadSampleData('migration')">Migration Flow</button>
                    <button onclick="loadSampleData('trade')">Trade Relations</button>
                    <button onclick="loadSampleData('communication')">Communication</button>
                    <button onclick="loadSampleData('collaboration')">Collaboration</button>
                </div>
                <textarea id="jsonInput" placeholder="Enter your chord data in JSON format..."></textarea>
                <div style="margin-top: 10px;">
                    <button onclick="renderChord()">Render Chord</button>
                    <button onclick="clearChord()">Clear</button>
                </div>
                <div id="error-message"></div>
            </div>
        </div>
        
        <svg id="chord" width="700" height="700"></svg>
        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // Sample data sets
        const sampleData = {
            migration: {
                labels: ["North America", "Europe", "Asia", "Africa", "South America", "Oceania"],
                matrix: [
                    [0, 15, 25, 8, 12, 3],      // North America to others
                    [18, 0, 20, 12, 8, 2],      // Europe to others
                    [22, 18, 0, 15, 6, 4],      // Asia to others
                    [5, 10, 18, 0, 3, 1],       // Africa to others
                    [8, 6, 4, 2, 0, 1],         // South America to others
                    [2, 1, 3, 1, 1, 0]          // Oceania to others
                ]
            },
            trade: {
                labels: ["USA", "China", "Germany", "Japan", "UK", "France"],
                matrix: [
                    [0, 120, 45, 80, 35, 25],   // USA trade with others
                    [115, 0, 60, 95, 28, 22],   // China trade with others
                    [42, 58, 0, 35, 55, 48],    // Germany trade with others
                    [78, 92, 38, 0, 25, 18],    // Japan trade with others
                    [33, 30, 52, 28, 0, 35],    // UK trade with others
                    [28, 25, 45, 20, 38, 0]     // France trade with others
                ]
            },
            communication: {
                labels: ["Marketing", "Sales", "Engineering", "Support", "HR", "Finance"],
                matrix: [
                    [0, 45, 15, 25, 20, 12],    // Marketing communications
                    [42, 0, 18, 35, 15, 22],    // Sales communications
                    [12, 20, 0, 40, 8, 10],     // Engineering communications
                    [28, 38, 42, 0, 18, 15],    // Support communications
                    [22, 18, 10, 20, 0, 25],    // HR communications
                    [15, 25, 12, 18, 28, 0]     // Finance communications
                ]
            },
            collaboration: {
                labels: ["Research", "Development", "Design", "Testing", "Documentation", "Management"],
                matrix: [
                    [0, 35, 20, 15, 25, 18],    // Research collaborations
                    [38, 0, 45, 30, 20, 22],    // Development collaborations
                    [22, 42, 0, 25, 15, 12],    // Design collaborations
                    [18, 32, 28, 0, 20, 15],    // Testing collaborations
                    [28, 22, 18, 22, 0, 20],    // Documentation collaborations
                    [20, 25, 15, 18, 22, 0]     // Management collaborations
                ]
            }
        };

        // Chord variables
        let svg, chord, arc, ribbon, tooltip;
        const width = 700;
        const height = 700;
        const outerRadius = Math.min(width, height) * 0.4;
        const innerRadius = outerRadius - 30;

        // Color scale
        const colors = d3.scaleOrdinal(d3.schemeCategory10);

        // Initialize
        function initializeSVG() {
            svg = d3.select("#chord")
                .attr("width", width)
                .attr("height", height);
            
            svg.selectAll("*").remove();
            
            const g = svg.append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);
            
            chord = d3.chord()
                .padAngle(0.05)
                .sortSubgroups(d3.descending);
            
            arc = d3.arc()
                .innerRadius(innerRadius)
                .outerRadius(outerRadius);
            
            ribbon = d3.ribbon()
                .radius(innerRadius);
            
            tooltip = d3.select("#tooltip");
            
            return g;
        }

        // Load sample data
        function loadSampleData(type) {
            const data = sampleData[type];
            document.getElementById('jsonInput').value = JSON.stringify(data, null, 2);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 5000);
        }

        // Render the Chord diagram
        function renderChord() {
            const jsonInput = document.getElementById('jsonInput').value.trim();
            
            if (!jsonInput) {
                showError('Please enter JSON data or load a sample.');
                return;
            }

            let data;
            try {
                data = JSON.parse(jsonInput);
            } catch (e) {
                showError('Invalid JSON format. Please check your data.');
                return;
            }

            if (!data.labels || !data.matrix) {
                showError('JSON must contain "labels" array and "matrix" array.');
                return;
            }

            // Validate matrix dimensions
            const n = data.labels.length;
            if (data.matrix.length !== n) {
                showError('Matrix must have same number of rows as labels.');
                return;
            }
            
            for (let i = 0; i < n; i++) {
                if (data.matrix[i].length !== n) {
                    showError(`Matrix row ${i} must have ${n} columns to match labels.`);
                    return;
                }
            }

            const g = initializeSVG();
            drawChord(g, data);
        }

        // Draw the Chord diagram
        function drawChord(g, data) {
            const chords = chord(data.matrix);
            
            // Draw the groups (arcs around the circle)
            const group = g.append("g")
                .selectAll("g")
                .data(chords.groups)
                .enter().append("g")
                .attr("class", "group");

            group.append("path")
                .attr("class", "group-arc")
                .style("fill", d => colors(d.index))
                .style("stroke", d => d3.rgb(colors(d.index)).darker())
                .attr("d", arc)
                .on("mouseover", function(event, d) {
                    fadeChords(d.index, 0.1);
                    showGroupTooltip(event, d, data.labels);
                })
                .on("mouseout", function() {
                    fadeChords(null, 1);
                    hideTooltip();
                });

            // Add group labels
            group.append("text")
                .attr("class", "group-label")
                .each(d => { d.angle = (d.startAngle + d.endAngle) / 2; })
                .attr("dy", ".35em")
                .attr("transform", d => `
                    rotate(${(d.angle * 180 / Math.PI - 90)})
                    translate(${outerRadius + 10})
                    ${d.angle > Math.PI ? "rotate(180)" : ""}
                `)
                .style("text-anchor", d => d.angle > Math.PI ? "end" : null)
                .text(d => data.labels[d.index]);

            // Draw the chords (ribbons between groups)
            g.append("g")
                .selectAll("path")
                .data(chords)
                .enter().append("path")
                .attr("class", "chord")
                .style("fill", d => colors(d.source.index))
                .attr("d", ribbon)
                .on("mouseover", function(event, d) {
                    d3.select(this).style("fill-opacity", 0.9);
                    showChordTooltip(event, d, data.labels, data.matrix);
                })
                .on("mouseout", function(event, d) {
                    d3.select(this).style("fill-opacity", 0.67);
                    hideTooltip();
                });
        }

        // Fade chords for highlighting
        function fadeChords(focusIndex, opacity) {
            svg.selectAll(".chord")
                .style("opacity", d => {
                    if (focusIndex === null) return 1;
                    return d.source.index === focusIndex || d.target.index === focusIndex ? 1 : opacity;
                });
            
            svg.selectAll(".group-arc")
                .style("opacity", d => {
                    if (focusIndex === null) return 1;
                    return d.index === focusIndex ? 1 : opacity;
                });
        }

        // Tooltip functions
        function showGroupTooltip(event, d, labels) {
            const totalOut = d.value;
            const groupName = labels[d.index];
            
            tooltip.style("opacity", 1)
                .html(`
                    <strong>${groupName}</strong><br/>
                    Total Flow: ${totalOut.toLocaleString()}<br/>
                    Index: ${d.index}
                `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }

        function showChordTooltip(event, d, labels, matrix) {
            const sourceName = labels[d.source.index];
            const targetName = labels[d.target.index];
            const sourceToTarget = matrix[d.source.index][d.target.index];
            const targetToSource = matrix[d.target.index][d.source.index];
            
            tooltip.style("opacity", 1)
                .html(`
                    <strong>Connection</strong><br/>
                    ${sourceName} → ${targetName}: ${sourceToTarget.toLocaleString()}<br/>
                    ${targetName} → ${sourceName}: ${targetToSource.toLocaleString()}<br/>
                    <strong>Total: ${(sourceToTarget + targetToSource).toLocaleString()}</strong>
                `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }

        function hideTooltip() {
            tooltip.style("opacity", 0);
        }

        // Clear Chord
        function clearChord() {
            if (svg) {
                svg.selectAll("*").remove();
            }
        }

        // Load migration sample on page load
        window.onload = function() {
            loadSampleData('migration');
        };
    </script>
</body>
</html>
